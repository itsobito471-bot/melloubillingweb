<nz-card [nzTitle]="titleTemplate">
    <ng-template #titleTemplate>
        <div style="display: flex; align-items: center;">
            <i nz-icon nzType="arrow-left" nzTheme="outline"
                style="cursor: pointer; margin-right: 16px; font-size: 18px;" (click)="onCancel()"
                nz-tooltip="Back to Bills"></i>
            <span style="font-size: 18px; font-weight: bold;">{{ isEditMode ? 'Edit Bill' : 'Create New Bill' }}</span>
        </div>
    </ng-template>

    <!-- Client Section -->
    <div class="section-container">
        <h3><i nz-icon nzType="user"></i> 1. Client Details</h3>

        <nz-space nzDirection="vertical" style="width: 100%;">
            <div *nzSpaceItem>
                <nz-select *ngIf="!isNewClient" [(ngModel)]="selectedClientId" nzPlaceHolder="Select Client"
                    nzShowSearch style="width: 100%; max-width: 400px;">
                    <nz-option *ngFor="let client of clients" [nzValue]="client._id"
                        [nzLabel]="client.name + ' - ' + client.phone"></nz-option>
                </nz-select>
            </div>

            <button *nzSpaceItem nz-button nzType="default" (click)="toggleNewClient()">
                <i nz-icon [nzType]="isNewClient ? 'close' : 'plus'"></i>
                {{ isNewClient ? 'Cancel' : 'Add New Client' }}
            </button>
        </nz-space>

        <nz-card *ngIf="isNewClient" class="new-client-card" nzTitle="New Client Information">
            <form nz-form [formGroup]="clientForm" nzLayout="vertical">
                <div nz-row [nzGutter]="16">
                    <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
                        <nz-form-item>
                            <nz-form-label nzRequired>Name</nz-form-label>
                            <nz-form-control nzErrorTip="Please enter name">
                                <input nz-input formControlName="name" placeholder="Client Name" />
                            </nz-form-control>
                        </nz-form-item>
                    </div>

                    <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
                        <nz-form-item>
                            <nz-form-label nzRequired>Phone</nz-form-label>
                            <nz-form-control nzErrorTip="Please enter phone">
                                <input nz-input formControlName="phone" placeholder="Phone Number" />
                            </nz-form-control>
                        </nz-form-item>
                    </div>

                    <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
                        <nz-form-item>
                            <nz-form-label>Area</nz-form-label>
                            <nz-form-control>
                                <nz-select formControlName="area" nzPlaceHolder="Select Area" nzShowSearch nzAllowClear
                                    (ngModelChange)="onAreaChange()">
                                    <nz-option *ngFor="let area of areas" [nzValue]="area.name"
                                        [nzLabel]="area.name"></nz-option>
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </div>

                    <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
                        <nz-form-item>
                            <nz-form-label>Subarea</nz-form-label>
                            <nz-form-control>
                                <nz-select formControlName="subarea" nzPlaceHolder="Select Subarea" nzShowSearch
                                    nzAllowClear [nzDisabled]="!selectedArea">
                                    <nz-option *ngFor="let subarea of filteredSubareas" [nzValue]="subarea"
                                        [nzLabel]="subarea"></nz-option>
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </div>

                    <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
                        <nz-form-item>
                            <nz-form-label>Address</nz-form-label>
                            <nz-form-control>
                                <input nz-input formControlName="address" placeholder="Address" />
                            </nz-form-control>
                        </nz-form-item>
                    </div>
                </div>

                <button nz-button nzType="primary" (click)="saveClient()">
                    <i nz-icon nzType="save"></i>
                    Save Client
                </button>
            </form>
        </nz-card>
    </div>

    <nz-divider></nz-divider>

    <!-- Items Section -->
    <div class="section-container">
        <h3><i nz-icon nzType="shopping-cart"></i> 2. Add Items</h3>

        <form nz-form [formGroup]="itemForm" nzLayout="inline">
            <nz-form-item>
                <nz-form-control nzErrorTip="Please select product">
                    <nz-select formControlName="productId" nzPlaceHolder="Select Product" nzShowSearch
                        style="width: 300px;">
                        <nz-option *ngFor="let product of products" [nzValue]="product._id"
                            [nzLabel]="product.code + ' - ' + product.name + ' (₹' + product.price + ')'">
                        </nz-option>
                    </nz-select>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item>
                <nz-form-control nzErrorTip="Please enter quantity">
                    <nz-input-number formControlName="quantity" [nzMin]="1" [nzStep]="1" nzPlaceHolder="Quantity"
                        style="width: 120px;"></nz-input-number>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item>
                <nz-form-control>
                    <button nz-button nzType="primary" (click)="addToBasket()">
                        <i nz-icon nzType="plus"></i>
                        Add
                    </button>
                </nz-form-control>
            </nz-form-item>
        </form>
    </div>

    <nz-divider></nz-divider>

    <!-- Summary Section -->
    <div class="section-container">
        <h3><i nz-icon nzType="file-text"></i> 3. Bill Summary</h3>

        <nz-table #basketTable [nzData]="basket" [nzShowPagination]="false" [nzScroll]="{ x: '500px' }">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total</th>
                    <th nzWidth="60px"></th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let item of basket; let i = index">
                    <td>{{ item.product.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>₹{{ item.product.price }}</td>
                    <td><strong>₹{{ item.product.price * item.quantity }}</strong></td>
                    <td>
                        <button nz-button nzType="link" nzDanger (click)="removeFromBasket(i)">
                            <i nz-icon nzType="delete"></i>
                        </button>
                    </td>
                </tr>
                <tr *ngIf="basket.length === 0">
                    <td colspan="5" style="text-align: center; color: #999;">
                        No items added yet
                    </td>
                </tr>
            </tbody>
            <tfoot *ngIf="basket.length > 0">
                <tr>
                    <td colspan="3" style="text-align: right;"><strong>Grand Total:</strong></td>
                    <td colspan="2">
                        <nz-statistic [nzValue]="getTotal()" nzPrefix="₹"
                            [nzValueStyle]="{ color: '#b78fd1', fontSize: '24px', fontWeight: 'bold' }"></nz-statistic>
                    </td>
                </tr>
            </tfoot>
        </nz-table>

        <div style="margin-top: 24px; text-align: right;">
            <button nz-button nzType="default" (click)="onCancel()" style="margin-right: 8px;">
                Cancel
            </button>
            <button nz-button nzType="primary" nzSize="large" [nzLoading]="loading"
                [disabled]="!selectedClientId || basket.length === 0" (click)="submitBill()">
                <i nz-icon nzType="check-circle"></i>
                {{ isEditMode ? 'Update Bill' : 'Generate Bill' }}
            </button>
        </div>
    </div>
</nz-card>