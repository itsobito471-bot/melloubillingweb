<nz-card nzTitle="Bills Management">
    <!-- Filters Section -->
    <div class="filters-container">
        <div nz-row [nzGutter]="[16, 16]">
            <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="8">
                <nz-input-group [nzPrefix]="prefixTemplate">
                    <input nz-input placeholder="Search by client name or phone" [(ngModel)]="searchText"
                        (ngModelChange)="onSearch()" />
                </nz-input-group>
                <ng-template #prefixTemplate>
                    <i nz-icon nzType="search"></i>
                </ng-template>
            </div>

            <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="8">
                <nz-range-picker [(ngModel)]="dateRange" (ngModelChange)="onDateRangeChange()" style="width: 100%;">
                </nz-range-picker>
            </div>

            <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="8">
                <div class="action-buttons-container">
                    <button nz-button nzType="default" (click)="clearFilters()">
                        <i nz-icon nzType="close"></i> Clear Filters
                    </button>
                    <button nz-button nzType="primary" (click)="onCreateBill()">
                        <i nz-icon nzType="plus"></i> Create Bill
                    </button>
                </div>
            </div>
        </div>
    </div>

    <nz-divider></nz-divider>

    <!-- Bills Table -->
    <nz-table #billsTable [nzData]="filteredBills" [nzLoading]="loading" [nzPageSize]="10" [nzScroll]="{ x: '800px' }">
        <thead>
            <tr>
                <th>Bill ID</th>
                <th>Date</th>
                <th>Client</th>
                <th>Phone</th>
                <th>Items</th>
                <th>Total Amount</th>
                <th nzWidth="180px" nzAlign="center">Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let bill of billsTable.data">
                <td>
                    <code style="font-size: 11px; color: #666;">{{ bill._id }}</code>
                </td>
                <td>{{ bill.date | date:'short' }}</td>
                <td><strong>{{ bill.client?.name || 'Unknown' }}</strong></td>
                <td>{{ bill.client?.phone || '-' }}</td>
                <td>
                    <nz-tag nzColor="blue">{{ bill.items?.length || 0 }} items</nz-tag>
                </td>
                <td>
                    <strong style="color: #b78fd1;">â‚¹{{ bill.finalAmount || getTotal(bill) }}</strong>
                </td>
                <td nzAlign="center">
                    <div class="action-buttons">
                        <button nz-button nzType="link" (click)="viewBill(bill)" nz-tooltip="View Bill">
                            <i nz-icon nzType="eye"></i>
                        </button>
                        <button nz-button nzType="link" [routerLink]="['edit', bill._id]" nz-tooltip="Edit Bill">
                            <i nz-icon nzType="edit"></i>
                        </button>
                        <button nz-button nzType="link" (click)="downloadPDF(bill._id)" nz-tooltip="Download PDF">
                            <i nz-icon nzType="download"></i>
                        </button>
                        <button nz-button nzType="link" nzDanger (click)="deleteBill(bill._id)"
                            nz-tooltip="Delete Bill">
                            <i nz-icon nzType="delete"></i>
                        </button>
                    </div>
                </td>
            </tr>
            <tr *ngIf="filteredBills.length === 0">
                <td colspan="7" style="text-align: center; color: #999; padding: 40px;">
                    <i nz-icon nzType="file-text" style="font-size: 48px; opacity: 0.3;"></i>
                    <p style="margin-top: 16px;">No bills found</p>
                    <button nz-button nzType="primary" (click)="onCreateBill()">
                        <i nz-icon nzType="plus"></i>
                        Create Your First Bill
                    </button>
                </td>
            </tr>
        </tbody>
    </nz-table>
</nz-card>

<!-- Bill Preview Modal -->
<nz-modal [(nzVisible)]="previewVisible" nzTitle="Bill Preview" [nzFooter]="modalFooter" (nzOnCancel)="closePreview()"
    [nzWidth]="900">
    <div *nzModalContent style="height: 70vh; display: flex; flex-direction: column;">
        <div *ngIf="pdfLoading"
            style="flex: 1; display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <nz-spin nzSize="large"></nz-spin>
            <p style="margin-top: 16px; color: #666;">Generating preview...</p>
        </div>

        <iframe *ngIf="!pdfLoading && pdfUrl" [src]="pdfUrl" width="100%" height="100%" frameborder="0"
            style="border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></iframe>

        <div *ngIf="!pdfLoading && !pdfUrl"
            style="flex: 1; display: flex; justify-content: center; align-items: center; flex-direction: column; background: #fff1f0; border: 1px solid #ffa39e; border-radius: 4px;">
            <i nz-icon nzType="exclamation-circle" style="font-size: 48px; color: #f5222d;"></i>
            <p style="margin-top: 16px; color: #cf1322; font-weight: bold;">Could not load preview</p>
            <button nz-button nzType="link" (click)="viewBill(selectedBill)">Try Again</button>
        </div>
    </div>
    <ng-template #modalFooter>
        <div class="preview-actions">
            <button nz-button nzType="default" (click)="closePreview()">Close</button>
            <button nz-button nzType="primary" (click)="downloadPDF(selectedBill?._id)" [disabled]="!selectedBill"
                style="margin-left: 12px; background: #b78fd1; border-color: #b78fd1;">
                <i nz-icon nzType="download"></i>
                Download PDF
            </button>
        </div>
    </ng-template>
</nz-modal>