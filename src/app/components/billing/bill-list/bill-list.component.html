<nz-card nzTitle="Bills Management">
    <!-- Filters Section -->
    <div class="filters-section" nz-row [nzGutter]="[16, 16]">
        <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="8">
            <nz-input-group [nzPrefix]="prefixTemplate">
                <input nz-input placeholder="Search by client name or phone" [(ngModel)]="searchText"
                    (ngModelChange)="onSearch()" />
            </nz-input-group>
            <ng-template #prefixTemplate>
                <i nz-icon nzType="search"></i>
            </ng-template>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="8">
            <nz-range-picker [(ngModel)]="dateRange" (ngModelChange)="onDateRangeChange()" style="width: 100%;">
            </nz-range-picker>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="4">
            <button nz-button nzType="default" (click)="clearFilters()" style="width: 100%;">
                <i nz-icon nzType="close"></i>
                Clear Filters
            </button>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="4">
            <button nz-button nzType="primary" (click)="onCreateBill()" style="width: 100%;">
                <i nz-icon nzType="plus"></i>
                Create Bill
            </button>
        </div>
    </div>

    <nz-divider></nz-divider>

    <!-- Bills Table -->
    <nz-table #billsTable [nzData]="filteredBills" [nzLoading]="loading" [nzPageSize]="10" [nzScroll]="{ x: '800px' }">
        <thead>
            <tr>
                <th>Bill ID</th>
                <th>Date</th>
                <th>Client</th>
                <th>Phone</th>
                <th>Items</th>
                <th>Total Amount</th>
                <th nzWidth="120px" nzAlign="center">Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let bill of billsTable.data">
                <td>
                    <code style="font-size: 11px; color: #666;">{{ bill._id }}</code>
                </td>
                <td>{{ bill.date | date:'short' }}</td>
                <td><strong>{{ bill.client?.name || 'Unknown' }}</strong></td>
                <td>{{ bill.client?.phone || '-' }}</td>
                <td>
                    <nz-tag nzColor="blue">{{ bill.items?.length || 0 }} items</nz-tag>
                </td>
                <td>
                    <strong style="color: #b78fd1;">₹{{ bill.finalAmount || getTotal(bill) }}</strong>
                </td>
                <td nzAlign="center">
                    <div class="action-buttons">
                        <button nz-button nzType="link" (click)="viewBill(bill)" nz-tooltip="View Bill">
                            <i nz-icon nzType="eye"></i>
                        </button>
                        <button nz-button nzType="link" (click)="downloadPDF(bill._id)" nz-tooltip="Download PDF">
                            <i nz-icon nzType="download"></i>
                        </button>
                        <button nz-button nzType="link" nzDanger (click)="deleteBill(bill._id)"
                            nz-tooltip="Delete Bill">
                            <i nz-icon nzType="delete"></i>
                        </button>
                    </div>
                </td>
            </tr>
            <tr *ngIf="filteredBills.length === 0">
                <td colspan="7" style="text-align: center; color: #999; padding: 40px;">
                    <i nz-icon nzType="file-text" style="font-size: 48px; opacity: 0.3;"></i>
                    <p style="margin-top: 16px;">No bills found</p>
                    <button nz-button nzType="primary" (click)="onCreateBill()">
                        <i nz-icon nzType="plus"></i>
                        Create Your First Bill
                    </button>
                </td>
            </tr>
        </tbody>
    </nz-table>
</nz-card>

<!-- Bill Preview Modal -->
<nz-modal [(nzVisible)]="previewVisible" nzTitle="Bill Preview" [nzFooter]="null" (nzOnCancel)="closePreview()"
    [nzWidth]="800">
    <div *nzModalContent>
        <div *ngIf="selectedBill" class="bill-preview-content">
            <div class="preview-header">
                <div class="business-info">
                    <h2 style="color: #b78fd1; font-weight: bold; margin-bottom: 4px;">Mellou</h2>
                    <p style="margin-bottom: 2px;"><strong>Bill ID:</strong> <code
                            style="font-size: 12px;"> {{ selectedBill?.billNumber }}</code></p>
                    <p><strong>Date:</strong> {{ selectedBill.date | date:'medium' }}</p>
                </div>
                <div class="client-info"
                    style="margin-top: 16px; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                    <h4
                        style="margin-top: 0; color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
                        Client Details</h4>
                    <p style="margin-bottom: 4px;"><strong>Name:</strong> {{ selectedBill.client?.name }}</p>
                    <p style="margin-bottom: 4px;"><strong>Phone:</strong> {{ selectedBill.client?.phone }}</p>
                    <p style="margin-bottom: 0;"><strong>Address:</strong> {{ selectedBill.client?.address }}
                        <span *ngIf="selectedBill.client?.area">({{ selectedBill.client?.area }} / {{
                            selectedBill.client?.subarea }})</span>
                    </p>
                </div>
            </div>

            <nz-divider></nz-divider>

            <nz-table #previewTable [nzData]="selectedBill.items" [nzShowPagination]="false" nzSize="small">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th nzWidth="100px">Price</th>
                        <th nzWidth="80px">Qty</th>
                        <th nzWidth="120px" nzAlign="right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of selectedBill.items">
                        <td>{{ item.name || 'Deleted Product' }}</td>
                        <td>₹{{ item.price }}</td>
                        <td>{{ item.quantity }}</td>
                        <td nzAlign="right"><strong>₹{{ item.price * item.quantity }}</strong></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; padding-top: 16px;"><strong>Grand Total:</strong></td>
                        <td nzAlign="right" style="padding-top: 16px;">
                            <strong style="color: #b78fd1; font-size: 24px;">₹{{ selectedBill.finalAmount ||
                                getTotal(selectedBill) }}</strong>
                        </td>
                    </tr>
                </tfoot>
            </nz-table>

            <div class="preview-actions"
                style="margin-top: 32px; text-align: right; border-top: 1px solid #f0f0f0; padding-top: 16px;">
                <button nz-button nzType="default" (click)="closePreview()">Close</button>
                <button nz-button nzType="primary" (click)="downloadPDF(selectedBill._id)"
                    style="margin-left: 12px; background: #b78fd1; border-color: #b78fd1;">
                    <i nz-icon nzType="download"></i>
                    Download PDF
                </button>
            </div>
        </div>
    </div>
</nz-modal>